name: Performance Regression

on:
  pull_request:
    branches: [main]

# Cancel in-progress runs on the same PR
concurrency:
  group: perf-regression-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  bundle-size:
    name: Bundle Size Budget
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        id: build
        run: |
          START=$(date +%s)
          pnpm build 2>&1 | tee /tmp/build-output.txt
          END=$(date +%s)
          echo "duration=$((END - START))" >> "$GITHUB_OUTPUT"
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder' }}
          NEXT_PUBLIC_SITE_URL: https://pms-nine-gold.vercel.app

      - name: Check bundle size budgets
        run: node .github/scripts/check-bundle-size.mjs

      - name: Comment build stats on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const duration = '${{ steps.build.outputs.duration }}';

            // Read build output for route summary
            let buildOutput = '';
            try {
              buildOutput = fs.readFileSync('/tmp/build-output.txt', 'utf8');
            } catch {}

            // Extract route table from build output
            const routeLines = buildOutput.split('\n').filter(line =>
              line.match(/^[├└┌│ƒ○]/) || line.includes('First Load JS')
            ).slice(0, 30);

            const body = [
              '## Performance Report',
              '',
              `**Build time:** ${duration}s`,
              '',
              '<details>',
              '<summary>Route sizes (from build output)</summary>',
              '',
              '```',
              routeLines.join('\n') || 'No route data extracted',
              '```',
              '</details>',
              '',
              '---',
              '*Generated by Performance Regression CI*',
            ].join('\n');

            // Find and update existing comment or create new
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.body.includes('## Performance Report') &&
              c.user.type === 'Bot'
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

  lighthouse-assertions:
    name: Lighthouse CWV Budget
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Wait for Vercel preview deployment
        uses: patrickedqvist/wait-for-vercel-preview@06c79330064b0e6ef7a2574603b62d3c98789125 # v1.3.2
        id: vercel_preview
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 300
          check_interval: 10

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.14.x

      - name: Run Lighthouse with assertions (public pages)
        run: |
          lhci autorun \
            --config=lighthouserc.js \
            --collect.url=${{ steps.vercel_preview.outputs.url }}/login \
            --collect.numberOfRuns=3 \
            --collect.settings.preset=desktop
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-assertion-results
          path: .lighthouseci/
          retention-days: 14
