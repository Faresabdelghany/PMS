name: Lighthouse CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # On push to main: audit production URL directly
  lighthouse-production:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install -g @lhci/cli@0.14.x
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Authenticate and extract cookies
        run: |
          node -e "
          const { chromium } = require('playwright');
          const fs = require('fs');
          (async () => {
            const browser = await chromium.launch({ headless: true });
            const context = await browser.newContext();
            const page = await context.newPage();

            await page.goto('https://pms-nine-gold.vercel.app/login', { waitUntil: 'networkidle' });
            await page.locator('input[type=\"email\"]').fill(process.env.TEST_USER_EMAIL);
            await page.locator('input[autocomplete=\"current-password\"]').fill(process.env.TEST_USER_PASSWORD);
            await page.locator('button[type=\"submit\"]').click();
            await page.waitForURL(url => !url.pathname.includes('/login'), { timeout: 30000 });

            // Save cookies in Puppeteer format for Lighthouse
            const cookies = await context.cookies();
            const puppeteerCookies = cookies.map(c => ({
              name: c.name,
              value: c.value,
              domain: c.domain,
              path: c.path,
              httpOnly: c.httpOnly,
              secure: c.secure,
              sameSite: c.sameSite === 'None' ? 'None' : c.sameSite === 'Lax' ? 'Lax' : 'Strict',
            }));
            fs.writeFileSync('/tmp/lh-cookies.json', JSON.stringify(puppeteerCookies));
            console.log('Authenticated successfully, saved ' + cookies.length + ' cookies');

            await browser.close();
          })();
          "
        env:
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - name: Run Lighthouse CI (public pages)
        run: |
          lhci autorun \
            --collect.url=https://pms-nine-gold.vercel.app/login \
            --collect.url=https://pms-nine-gold.vercel.app/signup \
            --collect.url=https://pms-nine-gold.vercel.app/forgot-password \
            --collect.numberOfRuns=3 \
            --collect.settings.preset=desktop
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Run Lighthouse CI (authenticated pages)
        run: |
          lhci autorun \
            --collect.url=https://pms-nine-gold.vercel.app/ \
            --collect.url=https://pms-nine-gold.vercel.app/projects \
            --collect.url=https://pms-nine-gold.vercel.app/tasks \
            --collect.url=https://pms-nine-gold.vercel.app/clients \
            --collect.url=https://pms-nine-gold.vercel.app/inbox \
            --collect.url=https://pms-nine-gold.vercel.app/settings \
            --collect.url=https://pms-nine-gold.vercel.app/reports \
            --collect.numberOfRuns=1 \
            --collect.settings.preset=desktop \
            --collect.puppeteerScript=.github/lighthouse/auth-script.cjs \
            --collect.chromePath=/usr/bin/google-chrome-stable
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results-production
          path: .lighthouseci/
          retention-days: 30

  # On PRs: wait for Vercel preview deployment, then audit
  lighthouse-preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Wait for Vercel preview deployment
        uses: patrickedqvist/wait-for-vercel-preview@06c79330064b0e6ef7a2574603b62d3c98789125 # v1.3.2
        id: vercel_preview
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 300
          check_interval: 10

      - name: Install dependencies
        run: |
          npm install -g @lhci/cli@0.14.x
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Authenticate and extract cookies
        run: |
          node -e "
          const { chromium } = require('playwright');
          const fs = require('fs');
          (async () => {
            const browser = await chromium.launch({ headless: true });
            const context = await browser.newContext();
            const page = await context.newPage();

            const baseUrl = process.env.PREVIEW_URL;
            await page.goto(baseUrl + '/login', { waitUntil: 'networkidle' });
            await page.locator('input[type=\"email\"]').fill(process.env.TEST_USER_EMAIL);
            await page.locator('input[autocomplete=\"current-password\"]').fill(process.env.TEST_USER_PASSWORD);
            await page.locator('button[type=\"submit\"]').click();
            await page.waitForURL(url => !url.pathname.includes('/login'), { timeout: 30000 });

            const cookies = await context.cookies();
            const puppeteerCookies = cookies.map(c => ({
              name: c.name,
              value: c.value,
              domain: c.domain,
              path: c.path,
              httpOnly: c.httpOnly,
              secure: c.secure,
              sameSite: c.sameSite === 'None' ? 'None' : c.sameSite === 'Lax' ? 'Lax' : 'Strict',
            }));
            fs.writeFileSync('/tmp/lh-cookies.json', JSON.stringify(puppeteerCookies));
            console.log('Authenticated successfully, saved ' + cookies.length + ' cookies');

            await browser.close();
          })();
          "
        env:
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          PREVIEW_URL: ${{ steps.vercel_preview.outputs.url }}

      - name: Run Lighthouse CI (public pages)
        run: |
          lhci autorun \
            --collect.url=${{ steps.vercel_preview.outputs.url }}/login \
            --collect.url=${{ steps.vercel_preview.outputs.url }}/signup \
            --collect.url=${{ steps.vercel_preview.outputs.url }}/forgot-password \
            --collect.numberOfRuns=3 \
            --collect.settings.preset=desktop
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Run Lighthouse CI (authenticated pages)
        run: |
          lhci autorun \
            --collect.url=${{ steps.vercel_preview.outputs.url }}/ \
            --collect.url=${{ steps.vercel_preview.outputs.url }}/projects \
            --collect.url=${{ steps.vercel_preview.outputs.url }}/tasks \
            --collect.url=${{ steps.vercel_preview.outputs.url }}/clients \
            --collect.url=${{ steps.vercel_preview.outputs.url }}/inbox \
            --collect.url=${{ steps.vercel_preview.outputs.url }}/settings \
            --collect.url=${{ steps.vercel_preview.outputs.url }}/reports \
            --collect.numberOfRuns=1 \
            --collect.settings.preset=desktop \
            --collect.puppeteerScript=.github/lighthouse/auth-script.cjs \
            --collect.chromePath=/usr/bin/google-chrome-stable
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results-preview
          path: .lighthouseci/
          retention-days: 30
